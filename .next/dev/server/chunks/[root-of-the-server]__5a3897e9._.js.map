{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/Kisaanmittr/app/api/compile/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\r\nimport { PDFDocument, rgb, StandardFonts } from 'pdf-lib';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    const { sections, userId } = body;\r\n\r\n    console.log('üìÑ PDF compilation request received');\r\n    console.log(`   Sections count: ${sections?.length || 0}`);\r\n\r\n    if (!sections || !Array.isArray(sections) || sections.length === 0) {\r\n      console.error('‚ùå Invalid request: sections array is required');\r\n      return NextResponse.json({\r\n        success: false,\r\n        error: 'Sections array is required',\r\n        details: 'Please provide at least one section with name and content',\r\n      }, { status: 400 });\r\n    }\r\n\r\n    // Validate sections have required fields\r\n    const invalidSections = sections.filter(\r\n      (section: any) => !section.name || typeof section.content !== 'string'\r\n    );\r\n    if (invalidSections.length > 0) {\r\n      console.error('‚ùå Invalid sections found:', invalidSections.length);\r\n      return NextResponse.json({\r\n        success: false,\r\n        error: 'Invalid sections',\r\n        details: 'Each section must have a name and content field',\r\n      }, { status: 400 });\r\n    }\r\n\r\n    // Create a new PDF document\r\n    const pdfDoc = await PDFDocument.create();\r\n    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);\r\n    const boldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);\r\n\r\n    let yPosition = 750;\r\n    const pageWidth = 595;\r\n    const pageHeight = 842;\r\n    const margin = 50;\r\n    const lineHeight = 20;\r\n    const sectionSpacing = 30;\r\n\r\n    // Helper function to add a new page if needed\r\n    const checkNewPage = () => {\r\n      if (yPosition < 100) {\r\n        const newPage = pdfDoc.addPage([pageWidth, pageHeight]);\r\n        yPosition = pageHeight - margin;\r\n        return newPage;\r\n      }\r\n    };\r\n\r\n    // Add title page\r\n    let page = pdfDoc.addPage([pageWidth, pageHeight]);\r\n    page.drawText('Kisaanmittr Report', {\r\n      x: margin,\r\n      y: pageHeight - 100,\r\n      size: 24,\r\n      font: boldFont,\r\n      color: rgb(0.13, 0.39, 0.23), // Primary green color\r\n    });\r\n\r\n    page.drawText(`Generated on: ${new Date().toLocaleDateString()}`, {\r\n      x: margin,\r\n      y: pageHeight - 140,\r\n      size: 12,\r\n      font: font,\r\n      color: rgb(0.3, 0.3, 0.3),\r\n    });\r\n\r\n    // Table of Contents\r\n    yPosition = pageHeight - 200;\r\n    page.drawText('Table of Contents', {\r\n      x: margin,\r\n      y: yPosition,\r\n      size: 16,\r\n      font: boldFont,\r\n      color: rgb(0, 0, 0),\r\n    });\r\n\r\n    yPosition -= 30;\r\n    sections.forEach((section: any, index: number) => {\r\n      if (yPosition < 100) {\r\n        page = pdfDoc.addPage([pageWidth, pageHeight]);\r\n        yPosition = pageHeight - margin;\r\n      }\r\n      page.drawText(`${index + 1}. ${section.name}`, {\r\n        x: margin + 20,\r\n        y: yPosition,\r\n        size: 12,\r\n        font: font,\r\n        color: rgb(0, 0, 0),\r\n      });\r\n      yPosition -= lineHeight;\r\n    });\r\n\r\n    // Add sections\r\n    for (let index = 0; index < sections.length; index++) {\r\n      const section = sections[index];\r\n      page = pdfDoc.addPage([pageWidth, pageHeight]);\r\n      yPosition = pageHeight - margin;\r\n\r\n      // Section header\r\n      page.drawText(`${index + 1}. ${section.name}`, {\r\n        x: margin,\r\n        y: yPosition,\r\n        size: 18,\r\n        font: boldFont,\r\n        color: rgb(0.13, 0.39, 0.23),\r\n      });\r\n\r\n      yPosition -= sectionSpacing;\r\n\r\n      // Section content\r\n      const content = section.content || '';\r\n      \r\n      // Handle empty content\r\n      if (!content || content.trim().length === 0) {\r\n        if (yPosition < 100) {\r\n          page = pdfDoc.addPage([pageWidth, pageHeight]);\r\n          yPosition = pageHeight - margin;\r\n        }\r\n        page.drawText('(No content provided)', {\r\n          x: margin,\r\n          y: yPosition,\r\n          size: 11,\r\n          font: font,\r\n          color: rgb(0.5, 0.5, 0.5), // Gray color for empty content\r\n        });\r\n        yPosition -= lineHeight;\r\n        continue; // Skip to next section\r\n      }\r\n\r\n      // Split content into words and handle line wrapping\r\n      const words = content.split(/\\s+/).filter((word: string) => word.length > 0);\r\n      let currentLine = '';\r\n\r\n      words.forEach((word: string) => {\r\n        // Handle newlines in content\r\n        if (word.includes('\\n')) {\r\n          const lines = word.split('\\n');\r\n          lines.forEach((line: string, lineIndex: number) => {\r\n            if (lineIndex === 0) {\r\n              // First part of the word\r\n              const testLine = currentLine + (currentLine ? ' ' : '') + line;\r\n              const textWidth = font.widthOfTextAtSize(testLine, 11);\r\n              \r\n              if (textWidth > pageWidth - 2 * margin && currentLine) {\r\n                // Draw current line and start new line\r\n                if (yPosition < 100) {\r\n                  page = pdfDoc.addPage([pageWidth, pageHeight]);\r\n                  yPosition = pageHeight - margin;\r\n                }\r\n                page.drawText(currentLine, {\r\n                  x: margin,\r\n                  y: yPosition,\r\n                  size: 11,\r\n                  font: font,\r\n                  color: rgb(0, 0, 0),\r\n                });\r\n                yPosition -= lineHeight;\r\n                currentLine = line;\r\n              } else {\r\n                currentLine = testLine;\r\n              }\r\n            } else {\r\n              // Subsequent lines (after newline)\r\n              if (currentLine) {\r\n                if (yPosition < 100) {\r\n                  page = pdfDoc.addPage([pageWidth, pageHeight]);\r\n                  yPosition = pageHeight - margin;\r\n                }\r\n                page.drawText(currentLine, {\r\n                  x: margin,\r\n                  y: yPosition,\r\n                  size: 11,\r\n                  font: font,\r\n                  color: rgb(0, 0, 0),\r\n                });\r\n                yPosition -= lineHeight;\r\n              }\r\n              currentLine = line;\r\n            }\r\n          });\r\n          return;\r\n        }\r\n\r\n        // Regular word wrapping\r\n        const testLine = currentLine + (currentLine ? ' ' : '') + word;\r\n        const textWidth = font.widthOfTextAtSize(testLine, 11);\r\n\r\n        if (textWidth > pageWidth - 2 * margin) {\r\n          if (currentLine) {\r\n            if (yPosition < 100) {\r\n              page = pdfDoc.addPage([pageWidth, pageHeight]);\r\n              yPosition = pageHeight - margin;\r\n            }\r\n            page.drawText(currentLine, {\r\n              x: margin,\r\n              y: yPosition,\r\n              size: 11,\r\n              font: font,\r\n              color: rgb(0, 0, 0),\r\n            });\r\n            yPosition -= lineHeight;\r\n          }\r\n          currentLine = word;\r\n        } else {\r\n          currentLine = testLine;\r\n        }\r\n      });\r\n\r\n      // Draw remaining text\r\n      if (currentLine) {\r\n        if (yPosition < 100) {\r\n          page = pdfDoc.addPage([pageWidth, pageHeight]);\r\n          yPosition = pageHeight - margin;\r\n        }\r\n        page.drawText(currentLine, {\r\n          x: margin,\r\n          y: yPosition,\r\n          size: 11,\r\n          font: font,\r\n          color: rgb(0, 0, 0),\r\n        });\r\n        yPosition -= lineHeight;\r\n      }\r\n    }\r\n\r\n    // Add page numbers\r\n    const pages = pdfDoc.getPages();\r\n    pages.forEach((page, index) => {\r\n      const pageNumber = (index + 1).toString();\r\n      const textWidth = font.widthOfTextAtSize(pageNumber, 10);\r\n      page.drawText(pageNumber, {\r\n        x: (pageWidth - textWidth) / 2,\r\n        y: 30,\r\n        size: 10,\r\n        font: font,\r\n        color: rgb(0.5, 0.5, 0.5),\r\n      });\r\n    });\r\n\r\n    // Generate PDF bytes\r\n    console.log('üîÑ Generating PDF bytes...');\r\n    const pdfBytes = await pdfDoc.save();\r\n    console.log(`‚úÖ PDF generated successfully (${pdfBytes.length} bytes)`);\r\n\r\n    // Generate filename with timestamp\r\n    const timestamp = new Date().toISOString().split('T')[0];\r\n    const filename = `kisaanmittr-report-${timestamp}.pdf`;\r\n\r\n    // Return PDF as binary response\r\n    console.log(`üì§ Sending PDF response: ${filename} (${pdfBytes.length} bytes)`);\r\n    \r\n    // Ensure pdfBytes is a Uint8Array/Buffer\r\n    const pdfBuffer = Buffer.from(pdfBytes);\r\n    \r\n    return new NextResponse(pdfBuffer, {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'application/pdf',\r\n        'Content-Disposition': `attachment; filename=\"${filename}\"`,\r\n        'Content-Length': pdfBuffer.length.toString(),\r\n        'Cache-Control': 'no-cache',\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    // Enhanced error logging\r\n    console.error('‚ùå PDF compilation error:', {\r\n      message: error.message,\r\n      type: error.constructor.name,\r\n      stack: error.stack,\r\n    });\r\n\r\n    // Return JSON error response\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: 'Failed to compile PDF',\r\n      details: error.message || 'An unexpected error occurred during PDF generation',\r\n    }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}