{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///E:/Kisaanmittr/app/api/generate/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport OpenAI from 'openai';\n\n// Cached OpenAI client instance\nlet openaiClient: OpenAI | null = null;\nlet clientInitialized = false;\n\n// Lazy initialization function for OpenAI client (cached after first initialization)\nfunction getOpenAIClient() {\n  // Return cached client if already initialized\n  if (clientInitialized) {\n    return openaiClient;\n  }\n\n  const apiKey = process.env.OPENAI_API_KEY;\n  \n  if (!apiKey) {\n    console.error('‚ùå OPENAI_API_KEY is not set in environment variables');\n    clientInitialized = true; // Mark as initialized to prevent repeated logs\n    return null;\n  }\n\n  // Validate API key format (should start with 'sk-')\n  if (!apiKey.startsWith('sk-')) {\n    console.warn('‚ö†Ô∏è  OPENAI_API_KEY format may be incorrect (should start with \"sk-\")');\n  }\n\n  try {\n    openaiClient = new OpenAI({\n      apiKey: apiKey,\n    });\n    console.log('‚úÖ OpenAI client initialized successfully');\n    clientInitialized = true;\n    return openaiClient;\n  } catch (error: any) {\n    console.error('‚ùå Failed to initialize OpenAI client:', error.message);\n    clientInitialized = true; // Mark as initialized to prevent repeated logs\n    return null;\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { prompt, itemName } = body;\n\n    // Initialize OpenAI client lazily (ensures env vars are loaded)\n    const openai = getOpenAIClient();\n\n    if (!openai) {\n      console.error('OpenAI API key is not configured');\n      return NextResponse.json({\n        success: false,\n        error: 'OpenAI API key is not configured',\n        details: 'Please set OPENAI_API_KEY in .env file',\n      }, { status: 500 });\n    }\n\n    if (!prompt) {\n      console.warn('Request missing prompt parameter');\n      return NextResponse.json({ \n        success: false,\n        error: 'Prompt is required' \n      }, { status: 400 });\n    }\n\n    console.log(`üìù Generating content for prompt: ${prompt.substring(0, 50)}...`);\n\n    const systemPrompt = `You are an agricultural expert assistant. Generate comprehensive, well-structured content for agricultural reports. \n    The content should be professional, informative, and suitable for inclusion in a formal report document.`;\n\n    console.log('üîÑ Calling OpenAI API...');\n    const completion = await openai.chat.completions.create({\n      model: 'gpt-4o-mini',\n      messages: [\n        { role: 'system', content: systemPrompt },\n        { role: 'user', content: prompt },\n      ],\n      temperature: 0.7,\n      max_tokens: 2000,\n    });\n\n    const generatedText = completion.choices[0]?.message?.content || '';\n\n    if (!generatedText) {\n      console.warn('‚ö†Ô∏è  OpenAI returned empty response');\n      return NextResponse.json({\n        success: false,\n        error: 'Received empty response from OpenAI',\n        details: 'The API call succeeded but no content was generated',\n      }, { status: 500 });\n    }\n\n    console.log(`‚úÖ Generated ${generatedText.length} characters of content`);\n\n    return NextResponse.json({\n      success: true,\n      content: generatedText,\n      itemName: itemName || 'Generated Content',\n      timestamp: new Date().toISOString(),\n    });\n  } catch (error: any) {\n    // Enhanced error logging - OpenAI SDK errors have specific structure\n    const errorStatus = (error as any).status || (error as any).statusCode || (error as any).response?.status;\n    const errorMessage = error.message || 'Unknown error';\n    const errorType = (error as any).type || error.constructor.name;\n    const errorCode = (error as any).code;\n    \n    console.error('‚ùå OpenAI API Error:', {\n      message: errorMessage,\n      type: errorType,\n      status: errorStatus,\n      code: errorCode,\n      error: (error as any).error || 'No error details',\n    });\n\n    // Handle specific OpenAI API errors\n    if (errorStatus === 401) {\n      return NextResponse.json({\n        success: false,\n        error: 'OpenAI API authentication failed',\n        details: 'Invalid API key. Please check your OPENAI_API_KEY in .env',\n      }, { status: 401 });\n    }\n\n    if (errorStatus === 429) {\n      return NextResponse.json({\n        success: false,\n        error: 'OpenAI API rate limit exceeded',\n        details: 'Please try again later',\n      }, { status: 429 });\n    }\n\n    if (errorStatus === 500 || errorStatus === 503) {\n      return NextResponse.json({\n        success: false,\n        error: 'OpenAI API service unavailable',\n        details: 'The OpenAI service is temporarily unavailable. Please try again later.',\n      }, { status: 503 });\n    }\n\n    // Handle network/connection errors\n    if (errorCode === 'ECONNREFUSED' || errorCode === 'ENOTFOUND') {\n      return NextResponse.json({\n        success: false,\n        error: 'Cannot connect to OpenAI API',\n        details: 'Network error. Please check your internet connection.',\n      }, { status: 503 });\n    }\n\n    // Generic error response\n    return NextResponse.json({\n      success: false,\n      error: 'Failed to generate content',\n      details: errorMessage || 'An unexpected error occurred',\n    }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}