{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///E:/Kisaanmittr/app/api/extract/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\r\nimport pdfParse from 'pdf-parse';\r\nimport mammoth from 'mammoth';\r\nimport * as XLSX from 'xlsx';\r\nimport fs from 'fs/promises';\r\nimport path from 'path';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const formData = await request.formData();\r\n    const file = formData.get(\"file\") as File;\r\n\r\n    if (!file) {\r\n      return NextResponse.json({ error: \"No file uploaded\" }, { status: 400 });\r\n    }\r\n\r\n    // Ensure uploads directory exists\r\n    const uploadsDir = path.join(process.cwd(), 'uploads');\r\n    await fs.mkdir(uploadsDir, { recursive: true });\r\n\r\n    // Save file temporarily\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n    const fileExtension = path.extname(file.name).toLowerCase();\r\n    const tempFilePath = path.join(uploadsDir, `${Date.now()}-${file.name}`);\r\n\r\n    try {\r\n      await fs.writeFile(tempFilePath, buffer);\r\n\r\n      let extractedText = '';\r\n\r\n      switch (fileExtension) {\r\n        case '.pdf':\r\n          const pdfData = await pdfParse(buffer);\r\n          extractedText = pdfData.text;\r\n          break;\r\n\r\n        case '.docx':\r\n          const docxResult = await mammoth.extractRawText({ buffer: buffer });\r\n          extractedText = docxResult.value;\r\n          break;\r\n\r\n        case '.xlsx':\r\n        case '.xls':\r\n          const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n          const sheetName = workbook.SheetNames[0];\r\n          const worksheet = workbook.Sheets[sheetName];\r\n          extractedText = XLSX.utils.sheet_to_txt(worksheet);\r\n          break;\r\n\r\n        default:\r\n          throw new Error('Unsupported file format. Only PDF, DOCX, and XLSX files are allowed.');\r\n      }\r\n\r\n      // Clean up uploaded file\r\n      await fs.unlink(tempFilePath);\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        content: extractedText,\r\n        fileName: file.name,\r\n        fileType: fileExtension,\r\n        fileSize: file.size,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    } catch (error: any) {\r\n      // Clean up file on error\r\n      try {\r\n        await fs.unlink(tempFilePath).catch(() => {});\r\n      } catch (unlinkError) {\r\n        console.error('Error deleting file:', unlinkError);\r\n      }\r\n\r\n      throw error;\r\n    }\r\n  } catch (error: any) {\r\n    console.error('File parsing error:', error);\r\n    \r\n    // Check for invalid file type\r\n    if (error.message && error.message.includes('Invalid file type') || error.message.includes('Unsupported file format')) {\r\n      return NextResponse.json({\r\n        error: 'Invalid file type',\r\n        details: error.message,\r\n      }, { status: 400 });\r\n    }\r\n\r\n    return NextResponse.json({\r\n      error: 'Failed to parse file',\r\n      details: error.message || 'An unexpected error occurred',\r\n    }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,kCAAkC;QAClC,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;QAC5C,MAAM,gIAAE,CAAC,KAAK,CAAC,YAAY;YAAE,WAAW;QAAK;QAE7C,wBAAwB;QACxB,MAAM,cAAc,MAAM,KAAK,WAAW;QAC1C,MAAM,SAAS,OAAO,IAAI,CAAC;QAC3B,MAAM,gBAAgB,4GAAI,CAAC,OAAO,CAAC,KAAK,IAAI,EAAE,WAAW;QACzD,MAAM,eAAe,4GAAI,CAAC,IAAI,CAAC,YAAY,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,IAAI,EAAE;QAEvE,IAAI;YACF,MAAM,gIAAE,CAAC,SAAS,CAAC,cAAc;YAEjC,IAAI,gBAAgB;YAEpB,OAAQ;gBACN,KAAK;oBACH,MAAM,UAAU,MAAM,IAAA,kJAAQ,EAAC;oBAC/B,gBAAgB,QAAQ,IAAI;oBAC5B;gBAEF,KAAK;oBACH,MAAM,aAAa,MAAM,oJAAO,CAAC,cAAc,CAAC;wBAAE,QAAQ;oBAAO;oBACjE,gBAAgB,WAAW,KAAK;oBAChC;gBAEF,KAAK;gBACL,KAAK;oBACH,MAAM,WAAW,uIAAS,CAAC,QAAQ;wBAAE,MAAM;oBAAS;oBACpD,MAAM,YAAY,SAAS,UAAU,CAAC,EAAE;oBACxC,MAAM,YAAY,SAAS,MAAM,CAAC,UAAU;oBAC5C,gBAAgB,wIAAU,CAAC,YAAY,CAAC;oBACxC;gBAEF;oBACE,MAAM,IAAI,MAAM;YACpB;YAEA,yBAAyB;YACzB,MAAM,gIAAE,CAAC,MAAM,CAAC;YAEhB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,SAAS;gBACT,UAAU,KAAK,IAAI;gBACnB,UAAU;gBACV,UAAU,KAAK,IAAI;gBACnB,WAAW,IAAI,OAAO,WAAW;YACnC;QACF,EAAE,OAAO,OAAY;YACnB,yBAAyB;YACzB,IAAI;gBACF,MAAM,gIAAE,CAAC,MAAM,CAAC,cAAc,KAAK,CAAC,KAAO;YAC7C,EAAE,OAAO,aAAa;gBACpB,QAAQ,KAAK,CAAC,wBAAwB;YACxC;YAEA,MAAM;QACR;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,uBAAuB;QAErC,8BAA8B;QAC9B,IAAI,MAAM,OAAO,IAAI,MAAM,OAAO,CAAC,QAAQ,CAAC,wBAAwB,MAAM,OAAO,CAAC,QAAQ,CAAC,4BAA4B;YACrH,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,SAAS,MAAM,OAAO;YACxB,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO;YACP,SAAS,MAAM,OAAO,IAAI;QAC5B,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF","debugId":null}}]
}